# Requirements

## システム概要
工場内11台の機械のパトライト状態と電流値を監視し、Webに時系列・現在状態を表示するシステム。

## エッジユニット要件

### ハードウェア
- Raspberry Pi Pico (RP2040) + E220-900T22S(JP) (LoRa、日本版)
- SSD1306 OLED 128×64px（I2C1: GPIO26/27）
- LED × 4個（パネル引き出し、前面から視認可能）
  - D1(GPIO28): ハートビート・青（5秒周期で100msピカッと点滅、Core0+Core1の両方が生きているときのみ）
  - D2(GPIO22): LoRa受信確認・緑（コマンド受信のたびに100msピカッと点滅）
  - D3(GPIO14): モード表示・黄（設定/テストモード中点灯）
  - D4(GPIO15): センサー異常・赤（エラー時点灯）
- ボタン3個: 灰(GPIO7)=選択, 赤(GPIO8)=決定, 黒(GPIO9)=戻る
- DIPスイッチ4bit: DIP1(GPIO10)=パトライト監視, DIP2(GPIO11)=電流監視, DIP3-4=予備
- 1枚の基板でパトライト／電流の両機能に対応（DIPで判別）
- 両DIPをONにすれば1台で両機能を兼務可能
- **E220アドレスのTT（ユニット種別）**: firmwareがDIPスイッチの値を自動的にADDL（TT部分）として設定する
  - DIP1のみON → TT=01（パトライト専用）
  - DIP2のみON → TT=02（電流専用）
  - DIP1+DIP2ともON → TT=03（兼務）
  - **ADDH（機械番号MM）のみ、ユニットごとに `DESIRED_ADDH` 定数を書き換えること**

### センサー
- パトライト監視: TSL2561 × 3個（TCA9548A経由、I2C0: GPIO20/21）
- 電流監視: CTL-24-CLS + 10Ω抵抗、1.65Vオフセット → MCP3208（SPI: GPIO16-19）で読取
  - 交流電流のため複数サンプリングしてRMS計算した値を使用

### 機能要件
1. **通常動作モード**: GWからのポーリングに応答してセンサーデータを返す
2. **設定モード**（優先度順）:
   - 液晶+3ボタンによるローカルUI
   - LoRa経由でGWからリモート設定
   - USBシリアル経由でPCから設定
   - 設定対象: E220-900T22S(JP)の各種パラメータ（LoRaアドレス・チャンネル等）
3. **ローカルテストモード**: GW不在でセンサー値を液晶に表示
   - パトライトユニット: 3センサーのlux値を表示
   - 電流ユニット: AC波形をスナップショット表示（計測指示→短期サンプリング→表示） + RMS電流値を表示
4. **設定確認**: 現在の設定値を液晶で確認
5. **OTA**（最後に実装・任意）: LoRa経由でファームウェア更新

## ゲートウェイ要件

### ハードウェア
- Raspberry Pi 5 + USB接続 E220-900T22S(JP)

### 機能要件
- 22ユニット全台を1分以内にポーリング完了
- GW設定ファイルで「機械名 → {パトライトユニットのLoRaアドレス, 電流ユニットのLoRaアドレス}」を管理
- 1機械の2ユニットから取得したデータを統合して1行のCSVに記録
- データ保存: `data/sensor/<機械名>/YYYY-MM-DD.csv`
- 品目データ取得: 別サーバからSMB経由で `data/hinmoku/` に同期

## Webアプリ要件
- 11台分の現在状態を一覧表示
- 時系列グラフ表示（日・月単位）
- 品目との突合せ表示
- 状態判定はGW側で実施（閾値は機械ごとに設定ファイルで管理）
