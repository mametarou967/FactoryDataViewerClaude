# Decisions

## 通信方式: ポーリング型を採用
- **決定**: GWがマスター、エッジがスレーブのポーリング型
- **理由**: 22ユニットが非同期送信すると電波衝突が発生する。機械が増えるほど衝突頻度が上がりスケールしない。ポーリング型は順番に問い合わせるため衝突を原理的に回避できる。

## ユニット種別把握: GW設定ファイル方式
- **決定**: GWの設定ファイルにユニット種別を記載（初回ハンドシェイクは不採用）
- **理由**: シンプルで確実。22台規模ならば手動設定のコストは許容範囲。

## データ保存: 機械ごとにサブディレクトリ
- **決定**: `data/sensor/<機械名>/YYYY-MM-DD.csv`
- **理由**: 機械ごとにファイルを分けることで、Web表示・検索・バックアップが容易になる。

## 1機械に2ユニットを紐付け
- **決定**: GW設定ファイルで `機械名 → {patlite_addr, current_addr}` をマッピング
- **理由**: パトライトと電源の取得位置が物理的に離れているため別ユニットが必要。ただしデータはGWで統合して1つの機械として扱う。同一ユニットが両機能を兼務する場合は同じアドレスを設定する。

## I2Cバスを2系統に分離（Wire / Wire1）
- **決定**: TCA9548A+TSL2561はWire（GPIO20/21）、SSD1306はWire1（GPIO26/27）
- **理由**: 回路設計時点で意図的に分離済み。バス競合なし。

## 状態判定ロジックの配置: GW側
- **決定**: エッジは生データ（lux値・電流値）を送るだけ。状態判定（加工中/停止等）はGWで行う。
- **理由**: 閾値は機械ごとに異なるため、GW側の設定で一元管理した方が変更が容易。

## OTAの実装順序: 最後
- **決定**: 通常機能・設定UI・ローカルテストがすべて完成してからOTAを追加
- **理由**: OTA失敗時にユニットが文鎮化するリスクがあるため、基本機能が安定してからの方が安全。
- **補足**: 設置場所が高所（3〜4m）のため物理アクセスが困難。LoRa経由OTA（9.6kbps設定で1台あたり5〜10分程度）で対応予定。
