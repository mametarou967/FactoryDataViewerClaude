# Tasklist

## Phase 1: パケットフォーマット設計 ✅
- [x] GW→エッジ のコマンドフォーマット確定
- [x] エッジ→GW のレスポンスフォーマット確定
- [x] エラー応答フォーマット確定
- [x] タイムアウト・再送ポリシー確定

## Phase 2: エッジ firmware（Pico）
### Step1: E220基本通信
- [ ] E220ドライバ実装（モード切替・送受信・AUX監視）
- [ ] AUX割り込みによるコマンド受信基盤実装（RISING edge → Serial2.available()で受信/送信後を区別）
- [ ] 起動時AUX=HIGH待ち（E220初期化完了確認後に割り込み有効化）
- [ ] Ping('K')応答
- [ ] バージョン('V')応答
- [ ] ハードウェア情報('H')応答（DIP状態・E220設定値）
- [ ] エラー応答('E')

### Step2: ポーリング応答（ダミーデータ）
- [ ] パトライト要求('P')にダミーデータで応答
- [ ] 電流要求('C')にダミーデータで応答

### Step3: センサー統合（デュアルコア）
- [ ] DIPスイッチ読取・ユニット種別判定
- [ ] Core1実装: TSL2561高速サイクリング + 直近1.5秒max値保持
- [ ] Core1実装: MCP3208高速サンプリング（~1kHz）+ RMS計算
- [ ] mutex_tによるコア間共有データ保護
- [ ] Core0: コマンド応答時に共有データを読み出して返送

### Step4: UI・設定
- [ ] SSD1306表示ドライバ（Wire1使用）
- [ ] ボタン入力処理（デバウンス含む）
- [ ] 設定UI（液晶+3ボタンによるメニュー）
- [ ] 設定確認画面
- [ ] E220設定の読み書き（設定値をE220のE2PROMに書込み・読出し）
- [ ] LoRa経由リモート設定
- [ ] USBシリアル経由設定

### Step5: ローカルテストモード
- [ ] パトライトユニット: 3センサーのlux値を液晶表示
- [ ] 電流ユニット: AC波形スナップショット表示（計測指示→短期サンプリング→表示） + RMS電流値表示

## Phase 3 & 4: GW + Webアプリ統合（app.py 再実装）
※ lora_logger.py と app.py を統合した1アプリとして実装する

### Step1: 基盤・ポーリング
- [ ] GW設定ファイル設計・実装（YAML）
- [ ] E220制御ドライバ（USB serial）
- [ ] バックグラウンドポーリングスレッド実装（1分周期）
- [ ] タイムアウト・再送処理
- [ ] データ統合（patlite + current → 1レコード）
- [ ] CSV書き込み（機械ごとサブディレクトリ）
- [ ] スレッドセーフなコマンドキュー実装（ポーリングとメンテ操作の調停）

### Step2: 監視Web UI
- [ ] config.yaml準拠の台数に対応したデータ読み取り構造
- [ ] 現在状態一覧画面（台数はconfig.yaml準拠、現在11台）
- [ ] 状態判定ロジックを設定ファイルベースに変更
- [ ] 日別・月別グラフ機能を多機械対応に拡張
- [ ] 品目突合せ表示

### Step3: メンテナンスWeb UI
- [ ] メンテナンス画面（ユニット選択・操作ボタン）
- [ ] Ping実行('K')・結果表示（個別 / 全台一括）
- [ ] バージョン確認('V')・結果表示（個別 / 全台一括）
- [ ] HW情報確認('H')・結果表示（DIP状態・E220設定値）
- [ ] OTA実行('U')（Phase5で実装）

### Step4: 運用対応
- [ ] systemdサービス設定（Restart=always）
- [ ] server_file_copy.py のcron設定

## Phase 5: OTA（任意・最後）
- [ ] ブートローダー設計（新ファームをFlashに書込み・検証・切替）
- [ ] GW側OTA配信ロジック
- [ ] パケット分割・CRC検証・再送制御
- [ ] ロールバック機能

## 完了済み
- [x] ハードウェア設計（KiCadスケマティック）
- [x] ピンアサイン確定
- [x] センサー読み取りコード（輝度・電流）
- [x] GWプロトタイプ動作確認
- [x] システム仕様確定
- [x] gitリポジトリ初期化
