# Tasklist

## Phase 1: パケットフォーマット設計 ✅
- [x] GW→エッジ のコマンドフォーマット確定
- [x] エッジ→GW のレスポンスフォーマット確定
- [x] エラー応答フォーマット確定
- [x] タイムアウト・再送ポリシー確定

## Phase 2: エッジ firmware（Pico）
### Step1: E220基本通信 ✅
- [x] E220ドライバ実装（モード切替・送受信・AUX監視）
- [x] AUX割り込みによるコマンド受信基盤実装（RISING edge → Serial2.available()で受信/送信後を区別）
- [x] 起動時AUX=HIGH待ち（E220初期化完了確認後に割り込み有効化）
- [x] Ping('K')応答
- [x] バージョン('V')応答
- [x] ハードウェア情報('H')応答（DIP状態・E220設定値）
- [x] エラー応答('E')

### Step2: ポーリング応答（ダミーデータ） ✅
- [x] パトライト要求('P')にダミーデータで応答
- [x] 電流要求('C')にダミーデータで応答

### Step3: センサー統合（デュアルコア）
#### Step3-1: TSL2561フェーズ ✅
- [x] DIPスイッチ読取・ユニット種別判定
- [x] Core1実装: TSL2561高速サイクリング（13ms/GAIN_1X）+ 直近1.5秒max値保持
- [x] mutex_tによるコア間共有データ保護
- [x] Core0: P('Patlite')コマンド応答時に共有データを読み出して返送
- [x] D1ハートビート: Core0+Core1両方が生きているときのみ点滅
- [x] D3センサー異常LED: TSL2561初期化失敗時に点灯
- [x] **動作確認**: 3ch実lux値・1.5秒maxウィンドウ保持・TCA CH1タイミング問題修正（delay(2)追加）すべて確認済み
#### Step3-2: MCP3208フェーズ（電流ユニット） ✅
- [x] Core1実装: MCP3208高速サンプリング（~1kHz）+ RMS計算
- [x] Core0: C('Current')コマンド応答時に共有データを読み出して返送
- [x] DIPスイッチの値をそのまま E220 ADDL(TT部分)に自動設定

#### Step3-2補足: 電流計測ノイズ対策（部品待ち・到着次第実施）
- [ ] **C1交換**: 47μF電解 → 10μF + 100nF セラミック並列（安全性向上）
- [ ] **VREF安定化**: MCP3208 VREFピン(15番)とAGND(14番)間に 10μF + 100nF セラミック並列を追加
- [ ] 改修後に `python3 tools/test_edge.py --addr 0x0102` でノイズフロア確認（目標: 1.15A → 大幅改善）
- [ ] 余裕があれば実電線クランプで精度確認（クランプメーターと比較）
- 原因: Pico 3.3Vレールの揺れ（3.2〜3.397V, 1〜2μs）がVREF直結で伝播。C1(47μF)がDCバイアスを安定させるためVREFとの比率がずれてノイズ化。
- 詳細: `.steering/design.md` の「電流計測ノイズ対策」セクション参照

### Step4: UI・設定
- [ ] SSD1306表示ドライバ（Wire1使用）
- [ ] ボタン入力処理（デバウンス含む）
- [ ] 設定UI（液晶+3ボタンによるメニュー）
- [ ] 設定確認画面
- [ ] E220設定の読み書き（設定値をE220のE2PROMに書込み・読出し）
- [ ] LoRa経由リモート設定
- [ ] USBシリアル経由設定

### Step5: ローカルテストモード
- [ ] パトライトユニット: 3センサーのlux値を液晶表示
- [ ] 電流ユニット: AC波形スナップショット表示（計測指示→短期サンプリング→表示） + RMS電流値表示

## Phase 3 & 4: GW + Webアプリ統合（app.py 再実装）
※ lora_logger.py と app.py を統合した1アプリとして実装する

### Step1: 基盤・ポーリング
- [ ] GW設定ファイル設計・実装（YAML）
- [ ] E220制御ドライバ（USB serial）
- [ ] バックグラウンドポーリングスレッド実装（1分周期）
- [ ] タイムアウト・再送処理
- [ ] データ統合（patlite + current → 1レコード）
- [ ] CSV書き込み（機械ごとサブディレクトリ）
- [ ] スレッドセーフなコマンドキュー実装（ポーリングとメンテ操作の調停）

### Step2: 監視Web UI
- [ ] config.yaml準拠の台数に対応したデータ読み取り構造
- [ ] 現在状態一覧画面（台数はconfig.yaml準拠、現在11台）
- [ ] 状態判定ロジックを設定ファイルベースに変更
- [ ] 日別・月別グラフ機能を多機械対応に拡張
- [ ] 品目突合せ表示

### Step3: メンテナンスWeb UI
- [ ] メンテナンス画面（ユニット選択・操作ボタン）
- [ ] Ping実行('K')・結果表示（個別 / 全台一括）
- [ ] バージョン確認('V')・結果表示（個別 / 全台一括）
- [ ] HW情報確認('H')・結果表示（DIP状態・E220設定値）
- [ ] OTA実行('U')（Phase5で実装）

### Step4: 運用対応
- [ ] systemdサービス設定（Restart=always）
- [ ] server_file_copy.py のcron設定

## Phase 5: OTA（任意・最後）
- [ ] ブートローダー設計（新ファームをFlashに書込み・検証・切替）
- [ ] GW側OTA配信ロジック
- [ ] パケット分割・CRC検証・再送制御
- [ ] ロールバック機能

## 完了済み
- [x] ハードウェア設計（KiCadスケマティック）
- [x] ピンアサイン確定
- [x] センサー読み取りコード（輝度・電流）
- [x] GWプロトタイプ動作確認
- [x] システム仕様確定
- [x] gitリポジトリ初期化
