# プロジェクト概要

Raspberry Pi Pico向けのArduinoスケッチ開発プロジェクト。

## 環境

- ターゲットボード：Raspberry Pi Pico
- 開発環境：Arduino IDE
- Arduinoコア：Earle Philhowerのarduino-pico


## システム構成

### 概要
工場内11台の機械を監視するシステム。パトライト状態と電源状態を収集しWebに表示する。

### エッジユニット（計22台）
- パトライト監視ユニット × 11台
- 電源状態監視ユニット × 11台
- ※パトライトと電源の取得位置が離れているため分離構成
- ハードウェア：Raspberry Pi Pico + E220-900T22S（LoRa）

### エッジユニットのUI・ハードウェア
- **液晶**：SSD1306 OLED 128×64px（I2C接続、設定・状態・波形表示に使用）
- **ボタン**：IO接続 × 3個（メニュー操作用）
- **DIPスイッチ**（4bit）：ユニット種別の判定に使用（LoRaアドレスとは無関係）
  - DIP1: パトライト監視ユニットとして動作するか
  - DIP2: 電流監視ユニットとして動作するか
  - DIP3: 予備
  - DIP4: 予備
  - ※両方ONで1台が両機能を兼務可能（設置場所によっては22台未満で構成できる）
- **LoRaアドレス**：設定UIから設定・保存

### エッジユニットの機能
#### 設定機能（優先度順）
1. 液晶 + 3ボタンによるローカルUI操作
2. LoRa経由でGWからリモート設定
3. USBシリアル経由でPCから設定
- 設定対象：E220-900T22Sの各種パラメータ（LoRaアドレス、チャンネル、ボーレート、エアレート等）
- ユニット種別はDIPスイッチ＋実装モジュールで決定、ソフト設定対象外
- センサー閾値はエッジ側に持たない（エッジは生データをGWに送るのみ）

#### メンテナンス機能
- 現在の設定値を液晶で確認できる（設定UIと統合でOK）
#### ローカルテスト機能
- **パトライト監視ユニット**：3センサーの読み取り値を液晶に表示
- **電流監視ユニット**：
  - センサー：CTL-24-CLS（ACクランプ）+ 1.65Vオフセット → MCP3208（SPI, 12bit）で読み取り
  - 液晶にAC波形をリアルタイム表示（オシロスコープ的な表示）
  - サンプリングしてRMS電流値を計算・表示
  - LoRaで送信する値もこの計算済み電流値（生ADC値ではない）
#### OTA（最後に実装・任意）
- LoRa経由でファームウェア更新（設置場所が高所のため物理アクセス困難）
- 想定転送時間：9.6kbps設定で1台あたり5〜10分程度
- 実装内容：パケット分割転送・CRC検証・失敗時ロールバック
- 通常機能がすべて完成した後に追加する

### エッジユニットの仕様
- 1種類の基板でパトライト／電流の両対応（DIPスイッチで判別）
- **パトライト監視ユニット**：輝度センサー（I2C）でパトライトの赤/黄/緑を検出
- **電流監視ユニット**：電流クランプ（ADC）で電流値（アンペア数）を取得・送信
- DIPスイッチ：ユニット種別の判定に使用（アドレス設定も兼ねる可能性あり）

### ゲートウェイ
- ハードウェア：Raspberry Pi 5
- LoRaモジュール：USB接続の E220-900T22S

### 通信
- エッジ ↔ ゲートウェイ間：LoRa（E220-900T22S）
- 通信方式：**ポーリング型**（GWがマスター、エッジがスレーブ）
  - GWが各エッジに順番に問い合わせ → エッジが応答
  - 衝突回避・スケーラビリティのためイベント駆動は不採用
- ゲートウェイ → Web：未確定
- I2C（輝度センサー）・ADC（電流クランプ）の読み取りコードは実装済み

### 既存プロトタイプのパケットフォーマット（lora_logger.pyより逆算）
- シリアル設定: /dev/ttyUSB0, 9600baud
- 終端: `\r\n`
- byte[0..2]: カスタムヘッダー（詳細不明）
- byte[3]: モード文字 `'C'`(電流) or `'D'`(パトライト)
- **'C'モード**: byte[4..末尾-2] = 電流値のASCII float文字列
- **'D'モード**: byte[4..9] = 赤/黄/緑 各uint16 ビッグエンディアン

### 既存CSVフォーマット（1機械分、1分ごと記録）
```
timestamp, red_lux, yellow_lux, green_lux, current_A
```
- 保存先（現行）: `data/sensor/YYYY-MM-DD.csv`
- 保存先（新設計）: `data/sensor/<機械名>/YYYY-MM-DD.csv`（機械ごとにサブディレクトリ）
  - 機械名は設定ファイルで管理
  - 1機械に対してパトライトユニットと電流ユニットの2つのLoRaアドレスが紐付く
    - 同一ユニットが両方兼務する場合は同じアドレスを設定
  - GW設定ファイル構造イメージ：
    ```
    機械名 → { patlite_addr: 0x0001, current_addr: 0x000C }
    ```
  - GWは2ユニットのデータを統合して1行のCSVに書き込む
  - 具体的な機械名は未確定（社内の機械番号・呼称を使用予定）
- 品目データ: `data/hinmoku/A214_YYYYMMDD_.csv`（SMB経由で別サーバから取得）

### 状態判定ロジック（app.pyより）
- パトライト閾値: 各色200lux以上で点灯判定
- 電流閾値: 3.0A以上で「加工中」判定
- 状態: 停止 / 自動加工中 / 手動加工中 / 加工完了 / アラーム

### 通信プロトコル（概要）
- GWがユニット種別を把握した上でコマンドを送信（**GW設定ファイルで管理**）
- **ポーリング周期：1分以内に22ユニット全台の値を取得する必要あり**
  - 1ユニットあたり約2.7秒以内に収める必要がある（60秒÷22台）
  - E220の応答時間から実現は十分可能な見込み
- **パトライト要求コマンド** → 応答：ユニットID + 赤/黄/緑の状態
- **電流要求コマンド** → 応答：ユニットID + 電流値（アンペア数）
  - 状態判定（給電なし／アイドル／自動加工／手動加工 等）はGW側で実施
  - 機械ごとに閾値が異なるため、判定ロジックはGWの設定で管理

## Pin Assignment（ネットリストより確定）

| 用途 | GPIO | 接続先 | 備考 |
|------|------|--------|------|
| LoRa M0 | GPIO2 | U2(E220) pin1 | |
| LoRa M1 | GPIO3 | U2(E220) pin2 | |
| LoRa TX | GPIO4 | U2(E220) pin3 RXD | Serial2 |
| LoRa RX | GPIO5 | U2(E220) pin4 TXD | Serial2 |
| LoRa AUX | GPIO6 | U2(E220) pin5 AUX | |
| ボタン1(灰) | GPIO7 | SW2 | 選択/ナビゲーション |
| ボタン2(赤) | GPIO8 | SW3 | 決定/実行 |
| ボタン3(黒) | GPIO9 | SW4 | キャンセル/戻る |
| DIP1 | GPIO10 | SW5 pin8 | パトライト監視ユニット判定 |
| DIP2 | GPIO11 | SW5 pin7 | 電流監視ユニット判定 |
| DIP3 | GPIO12 | SW5 pin6 | 予備 |
| DIP4 | GPIO13 | SW5 pin5 | 予備 |
| LED1 | GPIO14 | D3 | |
| LED2 | GPIO15 | D4 | |
| SPI MISO | GPIO16 | U1(MCP3208) Dout | |
| SPI CS | GPIO17 | U1(MCP3208) CS | |
| SPI SCK | GPIO18 | U1(MCP3208) CLK | |
| SPI MOSI | GPIO19 | U1(MCP3208) Din | |
| I2C0 SDA | GPIO20 | U3(TCA9548A) SDA | Wire、輝度センサー系 |
| I2C0 SCL | GPIO21 | U3(TCA9548A) SCL | Wire |
| LED3 | GPIO22 | D2 | |
| I2C1 SDA | GPIO26 | U4(SSD1306) SDA | Wire1、OLED |
| I2C1 SCL | GPIO27 | U4(SSD1306) SCL | Wire1、OLED |
| LED4 | GPIO28 | D1 | |
| RESET | RUN | SW1 | リセットボタン |

### 使用ライブラリ（既存コードより）
- `Wire.h` / `Adafruit_Sensor.h` / `Adafruit_TSL2561_U.h`（輝度センサー）
- `SPI.h`（MCP3208）

### センサー仕様（既存コードより）
- **TCA9548A**：I2Cマルチプレクサ（0x70）、CH0〜2にTSL2561を接続
- **TSL2561**：Gain 16X、積分時間 402ms、lux値として取得
- **MCP3208**：12bit SPI ADC、VREF=3.3V、SPI 1MHz、CH0で電流センサー読み取り

## Pin Assignment (RP2040 ↔ E220-900T22S)

| GPIO | Net名 | 接続先 |
|------|-------|--------|
| GPIO2 | M0 | E220-900T22S pin1 (M0) |
| GPIO3 | M1 | E220-900T22S pin2 (M1) |
| GPIO4 | RXD | E220-900T22S pin3 (RXD) |
| GPIO5 | TXD | E220-900T22S pin4 (TXD) |
| GPIO6 | AUX | E220-900T22S pin5 (AUX) |
